<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Tracker Test</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .media-container { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; }
        .event-log { margin-top: 20px; padding: 10px; border: 1px solid #eee; height: 300px; overflow-y: auto; background-color: #f9f9f9; }
        .event-log p { margin: 5px 0; font-size: 0.9em; }
        video, audio { max-width: 100%; }
    </style>
</head>
<body>
    <h1>Media Tracker Test Page</h1>

    <div class="media-container">
        <h2>Video 1 (with ID)</h2>
        <video id="video1" controls width="400">
            <source src="http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>

    <div class="media-container">
        <h2>Audio 1 (with ID, loop)</h2>
        <audio id="audio1" controls loop>
            <source src="http://commondatastorage.googleapis.com/codeskulptor-assets/Epoq-Lepidoptera.ogg" type="audio/ogg">
            Your browser does not support the audio tag.
        </audio>
    </div>

    <div class="media-container">
        <h2>Video 2 (no ID)</h2>
        <video controls width="400">
            <source src="http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>

    <div class="media-container">
        <h2>Video 3 (autoplay, muted, no ID)</h2>
        <video controls width="400" autoplay muted>
            <source src="http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>

    <div id="dynamic-media-container">
        <h2>Dynamically Added Media</h2>
        <!-- Media will be added here -->
    </div>
    <button id="addVideoBtn">Add Dynamic Video</button>
    <button id="addAudioBtn">Add Dynamic Audio</button>

    <h2>Event Log:</h2>
    <div id="eventLog" class="event-log"></div>

    <script src="media-tracker.js"></script>
    <script>
        const eventLog = document.getElementById('eventLog');

        function logEvent(eventName, detail) {
            const p = document.createElement('p');
            const detailString = Object.entries(detail)
                .map(([key, value]) => {
                    if (key === 'element') return `${key}: ${value.tagName}#${value.id}`;
                    return `${key}: ${typeof value === 'number' && value % 1 !== 0 ? value.toFixed(2) : value}`;
                })
                .join(', ');
            p.innerHTML = `<strong>${eventName}:</strong> ${detailString}`;
            eventLog.appendChild(p);
            eventLog.scrollTop = eventLog.scrollHeight; // Auto-scroll
        }

        document.addEventListener('mediaPlaybackMetadata', (e) => logEvent('mediaPlaybackMetadata', e.detail));
        document.addEventListener('mediaPlaybackStart', (e) => logEvent('mediaPlaybackStart', e.detail));
        document.addEventListener('mediaPlaybackPause', (e) => logEvent('mediaPlaybackPause', e.detail));
        document.addEventListener('mediaPlaybackEnd', (e) => logEvent('mediaPlaybackEnd', e.detail));
        document.addEventListener('mediaPlaybackUpdate', (e) => {
            // Optional: Throttle logging for timeupdate if it's too much
            // if (Math.random() < 0.1) { // Log only 10% of updates
                 logEvent('mediaPlaybackUpdate', e.detail);
            // }
        });

        document.getElementById('addVideoBtn').addEventListener('click', () => {
            const newVideo = document.createElement('video');
            newVideo.setAttribute('controls', '');
            newVideo.setAttribute('width', '300');
            const source = document.createElement('source');
            source.setAttribute('src', 'http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/Sintel.mp4');
            source.setAttribute('type', 'video/mp4');
            newVideo.appendChild(source);
            const title = document.createElement('h3');
            title.textContent = 'Dynamically Added Video';
            const container = document.getElementById('dynamic-media-container');
            container.appendChild(title);
            container.appendChild(newVideo);
            // Manually trigger play to see events if desired, or let user control
            // newVideo.play();
        });

        document.getElementById('addAudioBtn').addEventListener('click', () => {
            const newAudio = document.createElement('audio');
            newAudio.setAttribute('controls', '');
            const source = document.createElement('source');
            source.setAttribute('src', 'http://commondatastorage.googleapis.com/codeskulptor-assets/sounddogs.ogg');
            source.setAttribute('type', 'audio/ogg');
            newAudio.appendChild(source);
            const title = document.createElement('h3');
            title.textContent = 'Dynamically Added Audio';
            const container = document.getElementById('dynamic-media-container');
            container.appendChild(title);
            container.appendChild(newAudio);
        });

        // Display initial media tracker state (optional)
        setTimeout(() => {
            console.log("Initial mediaTracker state:", window.mediaTracker);
            Object.values(window.mediaTracker).forEach(media => {
                if (media.element) {
                     logEvent('InitialScan', { id: media.element.id, duration: media.duration, isPlaying: media.isPlaying, percentage: media.percentage, element: media.element });
                }
            });
        }, 500); // Wait a bit for initial scan and metadata
    </script>
</body>
</html>
